# 周易占卜方法与算法详解

## 1. 大衍筮法（蓍草法）

### 1.1 经典原文

《系辞传》原文：

> 大衍之数五十，其用四十有九。分而为二以象两，挂一以象三，揲之以四以象四时，归奇于扐以象闰。五岁再闰，故再扐而后挂。

### 1.2 完整操作流程

#### 准备

- 取蓍草50根，先取出1根置于案上不用（象征太极），实际使用49根
- 三变成一爻，六爻成一卦，共需十八变（18变 = 6爻 x 3变/爻）

#### 四营（一变的四个步骤）

**第一步：分二（象两仪）**
- 将当前蓍草随机分为左右两堆，左象天、右象地

**第二步：挂一（象三才）**
- 从右堆中取出1根，夹于左手小指与无名指之间（象征人）
- 此时参与后续运算的蓍草总数 = 原数 - 1

**第三步：揲四（象四时）**
- 将左堆每4根一组地数，直到剩余1~4根
- 将右堆每4根一组地数，直到剩余1~4根
- 左堆余数记为 `r_left`（1~4），右堆余数记为 `r_right`（1~4）

**第四步：归奇（象闰）**
- 将挂一的1根 + 左堆余数 + 右堆余数合并归扐
- 归扐总数 = 1 + r_left + r_right

#### 三变的余数规律

**第一变（从49根开始）：**
- 49 - 1（挂一）= 48根参与揲四
- 48 = 4a + r_left + 4b + r_right（其中 a+b 为整数，r_left, r_right 各为1~4）
- 关键约束：r_left + r_right 的可能值
  - 当 48 能被 8 整除分配时：r_left + r_right = 4 或 8
  - 归扐数 = 1 + r_left + r_right = **5 或 9**
- 第一变后剩余蓍草 = 49 - 归扐数 = **44 或 40**

**第二变（从44或40根开始）：**
- 剩余数 - 1（挂一）= 43 或 39
- 归扐数 = 1 + r_left + r_right = **4 或 8**
- 第二变后剩余蓍草 = 第一变剩余 - 归扐数

**第三变（继续操作）：**
- 同第二变，归扐数 = **4 或 8**
- 第三变后剩余蓍草为最终结果

#### 最终结果判定

三变后剩余蓍草数只有四种可能：**24、28、32、36**

除以4得到爻值：

| 剩余蓍草 | 除以4 | 爻值 | 爻名 | 性质 |
|---------|------|------|------|------|
| 24 | 6 | 6 | 老阴 | 阴极变阳（变爻）|
| 28 | 7 | 7 | 少阳 | 阳不变 |
| 32 | 8 | 8 | 少阴 | 阴不变 |
| 36 | 9 | 9 | 老阳 | 阳极变阴（变爻）|

### 1.3 概率分析

#### 第一变的概率

第一变中，49根取出挂一的1根后，48根随机分成两堆。设左堆为 `L`，右堆为 `48-L`。

- `L mod 4` 的余数为 r_left
- `(48-L) mod 4` 的余数为 r_right
- 由于 `L + (48-L) = 48`，`(r_left + r_right) mod 4 = 0`
- 所以 r_left + r_right = 4 或 8（不可能为0，因为余数范围是1~4）

归扐数为5的情况：r_left + r_right = 4，有3种组合：(1,3), (2,2), (3,1)
归扐数为9的情况：r_left + r_right = 8，只有1种组合：(4,4)

但需要考虑实际的分堆概率。在48根随机分堆中：
- L可取1~47的任意值
- L mod 4 = 0 的概率 = 12/48（L=4,8,...,44 去掉 48 共11个，但实际L从1~47）

精确计算：
- 归扐为5的概率 = **3/4**
- 归扐为9的概率 = **1/4**

等价地：第一变后剩余44根的概率为 3/4，剩余40根的概率为 1/4。

#### 第二变和第三变的概率

第二变和第三变中，归扐数为4或8，各自的概率：
- 归扐为4的概率 = **1/2**
- 归扐为8的概率 = **1/2**

#### 三变综合概率

用"少"表示归扐数小（第一变为5，后两变为4），"多"表示归扐数大（第一变为9，后两变为8）。

三变得到各爻值的路径：

| 爻值 | 三变路径（少/多） | 概率计算 | 概率 |
|------|-----------------|---------|------|
| 6（老阴）| 多、多、多 | 1/4 x 1/2 x 1/2 | **1/16** |
| 7（少阳）| 少、少、少 | 3/4 x 1/2 x 1/2 | 3/16 |
| 7（少阳）| 少、多、少 | ... | ... |
| 7（少阳）| 少、少、多 | ... | ... |
| ... | ... | ... | ... |

完整概率汇总：

| 爻值 | 名称 | 概率 | 约分 |
|------|------|------|------|
| 6 | 老阴（变爻）| 1/16 | 6.25% |
| 7 | 少阳（不变）| 5/16 | 31.25% |
| 8 | 少阴（不变）| 7/16 | 43.75% |
| 9 | 老阳（变爻）| 3/16 | 18.75% |

**关键特征：**
- 阳爻（7或9）总概率 = 5/16 + 3/16 = 8/16 = **1/2**
- 阴爻（6或8）总概率 = 1/16 + 7/16 = 8/16 = **1/2**
- 阴阳均衡，但变爻概率不对称：老阳(9)是老阴(6)的3倍
- 变爻总概率 = 1/16 + 3/16 = 4/16 = **1/4**

### 1.4 与铜钱法概率对比

| 指标 | 大衍筮法 | 铜钱法 |
|------|---------|--------|
| 老阴(6) | 1/16 = 6.25% | 1/8 = 12.5% |
| 少阳(7) | 5/16 = 31.25% | 3/8 = 37.5% |
| 少阴(8) | 7/16 = 43.75% | 3/8 = 37.5% |
| 老阳(9) | 3/16 = 18.75% | 1/8 = 12.5% |
| 阳爻总概率 | 1/2 | 1/2 |
| 变爻总概率 | 1/4 | 1/4 |
| 变爻对称性 | 不对称（9是6的3倍）| 对称（6和9各1/8）|

**分析：** 大衍筮法中阳爻变化（老阳9）的概率远高于阴爻变化（老阴6），体现了"阳主动、阴主静"的哲学思想。铜钱法则让变爻概率完全对称。

---

## 2. 铜钱法（三钱法/六爻法）

### 2.1 基本定义

使用三枚铜钱（或硬币）进行占卜。

**正反面定义（传统）：**
- 铜钱有字的一面（铸有文字如"开元通宝"）= **阴面**（字=阴），记为2
- 铜钱无字的一面（背面，通常铸花纹）= **阳面**（背=阳），记为3

> **注意：** 不同流派定义可能相反。主流传统以"字为阴(2)、背为阳(3)"为准。现代硬币一般以有国徽/花纹的面为正面（阳=3），有数字的面为反面（阴=2）。

### 2.2 投掷结果

三枚铜钱同时投掷，根据正反面组合得到四种结果：

| 组合 | 数值之和 | 爻值 | 爻名 | 记法 | 组合数 |
|------|---------|------|------|------|--------|
| 三背（三阳）| 3+3+3=9 | 9 | 老阳 | 画圈 O | C(3,3)=1 |
| 二背一字（二阳一阴）| 3+3+2=8 | 8 | 少阴 | 画叉 -- -- | C(3,2)=3 |
| 一背二字（一阳二阴）| 3+2+2=7 | 7 | 少阳 | 画横 ---- | C(3,1)=3 |
| 三字（三阴）| 2+2+2=6 | 6 | 老阴 | 画叉 X | C(3,0)=1 |

> **注意：** 这里"少阴=8、少阳=7"看似反直觉，但这是因为2代表阴、3代表阳的数值加和规则。少阳(7)的二阴一阳组合并非"多数为阳"，而是按数值加和的传统算法。

### 2.3 概率分布

每枚铜钱正反面等概率（各1/2），三枚独立投掷：

| 爻值 | 概率 | 百分比 |
|------|------|--------|
| 6（老阴）| 1/8 | 12.5% |
| 7（少阳）| 3/8 | 37.5% |
| 8（少阴）| 3/8 | 37.5% |
| 9（老阳）| 1/8 | 12.5% |

### 2.4 投掷顺序与记录

- 共投掷 **6次**，每次得一爻
- 顺序：从 **初爻（最下）到上爻（最上）**，即 **由下往上** 排列
- 第1次投掷 → 初爻（最底部）
- 第2次投掷 → 二爻
- 第3次投掷 → 三爻
- 第4次投掷 → 四爻
- 第5次投掷 → 五爻
- 第6次投掷 → 上爻（最顶部）

### 2.5 变爻判定

- 爻值为 **6（老阴）** 或 **9（老阳）** 的爻为变爻
- 变爻在本卦中按原值画，在变卦中取反：
  - 6（老阴）→ 变卦中变为阳爻
  - 9（老阳）→ 变卦中变为阴爻
- 7（少阳）和 8（少阴）为不变爻，在变卦中保持原样

### 2.6 编程实现（伪代码）

```
function throwCoins():
    // 模拟三枚铜钱
    sum = 0
    for i in 1..3:
        coin = random(0, 1)  // 0=字(阴,值2), 1=背(阳,值3)
        sum += (coin == 0) ? 2 : 3
    return sum  // 结果为 6, 7, 8, 或 9

function generateHexagram():
    yao = []  // 六爻数组，索引0=初爻，索引5=上爻
    for i in 0..5:
        yao[i] = throwCoins()
    return yao
```

---

## 3. 梅花易数

### 3.1 基本原理

梅花易数相传为北宋易学家 **邵雍（邵康节）** 所创。核心理念是"万物皆有数"，通过各种方式取数，再将数转换为卦象。与六爻法不同，梅花易数只有 **一个动爻**，且以 **体用关系** 为核心断卦方法。

### 3.2 基础数字对应

#### 先天八卦数（起卦用）

| 卦 | 乾 | 兑 | 离 | 震 | 巽 | 坎 | 艮 | 坤 |
|----|----|----|----|----|----|----|----|----|
| 数 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |

> 余数为0时，按8计算，对应坤卦。

#### 地支数（年份对应）

| 地支 | 子 | 丑 | 寅 | 卯 | 辰 | 巳 | 午 | 未 | 申 | 酉 | 戌 | 亥 |
|------|----|----|----|----|----|----|----|----|----|----|----|----|
| 数值 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 |

#### 时辰数

| 时辰 | 子 | 丑 | 寅 | 卯 | 辰 | 巳 | 午 | 未 | 申 | 酉 | 戌 | 亥 |
|------|----|----|----|----|----|----|----|----|----|----|----|----|
| 数值 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 |

### 3.3 时间起卦法

**公式：**
- 上卦 = (年地支数 + 农历月数 + 农历日数) mod 8
- 下卦 = (年地支数 + 农历月数 + 农历日数 + 时辰数) mod 8
- 动爻 = (年地支数 + 农历月数 + 农历日数 + 时辰数) mod 6

> 余数为0时：mod 8 结果为0按8（坤卦），mod 6 结果为0按6（上爻）

**示例：** 农历壬申年四月十一日巳时

- 年地支数：申 = 9
- 月数：4
- 日数：11
- 时辰数：巳 = 6
- 上卦 = (9 + 4 + 11) mod 8 = 24 mod 8 = 0 → 8 → 坤卦
- 下卦 = (9 + 4 + 11 + 6) mod 8 = 30 mod 8 = 6 → 坎卦
- 动爻 = (9 + 4 + 11 + 6) mod 6 = 30 mod 6 = 0 → 6 → 上爻
- 结果：地水师卦，上爻动

### 3.4 数字起卦法

- 来人随意报两个数字
- 第一个数 mod 8 → 上卦
- 第二个数 mod 8 → 下卦
- 两数之和 mod 6 → 动爻

**单数起卦：**
- 一个数字：前半位数（取整）为上卦，后半位数为下卦
- 例如：数字386 → 3为上卦（离），86 mod 8 = 6为下卦（坎），(3+8+6) mod 6 = 5 → 五爻动

### 3.5 文字起卦法（按笔画数）

- 一个字：字的总笔画数 mod 8 → 上卦，mod 8 → 下卦（用同一个数），总笔画 mod 6 → 动爻
- 两个字：第一个字笔画数 mod 8 → 上卦，第二个字笔画数 mod 8 → 下卦，两字笔画总和 mod 6 → 动爻
- 三个字及以上：前半字笔画总和 mod 8 → 上卦，后半字笔画总和 mod 8 → 下卦，全部笔画总和 mod 6 → 动爻

### 3.6 万物起卦法

邵雍提出"万物皆可起卦"的思想，根据观察到的事物特征转化为卦象：

- **方位起卦：** 来人方向对应后天八卦方位
- **声音起卦：** 听到声响的次数取数
- **颜色起卦：** 颜色对应五行再对应卦
- **物象起卦：** 物体特征直接对应八卦（如天=乾、地=坤、水=坎等）
- **动静起卦：** 观察某物的动态特征

### 3.7 体用关系判断

体用是梅花易数断卦的核心概念：

- **动爻所在的卦为"用卦"**（体现变化、代表事情）
- **不动的卦为"体卦"**（代表自己、主体）
- 动爻在上卦 → 上卦为用，下卦为体
- 动爻在下卦 → 下卦为用，上卦为体

**断卦原则：**
- 体克用：吉，我能控制局面
- 用克体：凶，外力压制我
- 体生用：泄气，付出多
- 用生体：吉，得到帮助
- 体用比和：吉，和谐

### 3.8 梅花易数与六爻的区别

| 特征 | 梅花易数 | 六爻（铜钱法） |
|------|---------|---------------|
| 起卦方式 | 时间、数字、万物 | 铜钱投掷 |
| 动爻数量 | 固定1个动爻 | 0~6个动爻均可能 |
| 断卦方法 | 以体用五行生克为主 | 以六亲、六神、世应为主 |
| 取卦依据 | 先天八卦数 | 铜钱随机 |
| 卦的层次 | 本卦、互卦、变卦 | 本卦、变卦、六亲、六神等 |
| 学习难度 | 入门较易，精通靠悟性 | 体系严密，规则繁复 |
| 适用场景 | 快速判断、灵感式占测 | 详细分析、事务推演 |

---

## 4. 纳甲法（京房易学）

### 4.1 概述

纳甲法由西汉京房创立，是六爻预测法的核心装卦系统。将天干、地支、五行等要素纳入六爻之中，形成完整的预测体系。

### 4.2 天干纳入六爻的规则（纳天干）

八纯卦（八经卦）各自纳入特定天干：

| 卦 | 纳天干 | 说明 |
|----|--------|------|
| 乾 | 甲（内卦）、壬（外卦）| 父卦，纳甲壬 |
| 坤 | 乙（内卦）、癸（外卦）| 母卦，纳乙癸 |
| 震 | 庚 | 长男，"长子代父" |
| 巽 | 辛 | 长女 |
| 坎 | 戊 | 中男 |
| 离 | 己 | 中女 |
| 艮 | 丙 | 少男 |
| 兑 | 丁 | 少女 |

**使用规则：**
- 重卦中，内卦（下卦）三爻使用该卦对应的第一个天干
- 外卦（上卦）三爻使用该卦对应的第二个天干（只有乾坤有两个天干，其余卦内外卦用同一天干）
- 例：乾卦内卦纳甲，外卦纳壬；震卦内外卦均纳庚

### 4.3 地支纳入六爻的规则（纳地支）

#### 阳卦（乾、震、坎、艮）顺排

| 卦 | 内卦（初→三爻） | 外卦（四→六爻） |
|----|----------------|----------------|
| 乾 | 子、寅、辰 | 午、申、戌 |
| 震 | 子、寅、辰 | 午、申、戌 |
| 坎 | 寅、辰、午 | 申、戌、子 |
| 艮 | 辰、午、申 | 戌、子、寅 |

规律：阳卦地支 **顺排**，每隔一位（即跳一个地支），乾震同起于子，坎起于寅，艮起于辰。

#### 阴卦（坤、巽、离、兑）逆排

| 卦 | 内卦（初→三爻） | 外卦（四→六爻） |
|----|----------------|----------------|
| 坤 | 未、巳、卯 | 丑、亥、酉 |
| 巽 | 丑、亥、酉 | 未、巳、卯 |
| 离 | 卯、丑、亥 | 酉、未、巳 |
| 兑 | 巳、卯、丑 | 亥、酉、未 |

规律：阴卦地支 **逆排**，每隔一位，坤起于未，巽起于丑，离起于卯，兑起于巳。

#### 编程用数据表（完整纳甲表）

```
纳甲表 = {
  乾: { 干: ["甲","甲","甲","壬","壬","壬"], 支: ["子","寅","辰","午","申","戌"] },
  坤: { 干: ["乙","乙","乙","癸","癸","癸"], 支: ["未","巳","卯","丑","亥","酉"] },
  震: { 干: ["庚","庚","庚","庚","庚","庚"], 支: ["子","寅","辰","午","申","戌"] },
  巽: { 干: ["辛","辛","辛","辛","辛","辛"], 支: ["丑","亥","酉","未","巳","卯"] },
  坎: { 干: ["戊","戊","戊","戊","戊","戊"], 支: ["寅","辰","午","申","戌","子"] },
  离: { 干: ["己","己","己","己","己","己"], 支: ["卯","丑","亥","酉","未","巳"] },
  艮: { 干: ["丙","丙","丙","丙","丙","丙"], 支: ["辰","午","申","戌","子","寅"] },
  兑: { 干: ["丁","丁","丁","丁","丁","丁"], 支: ["巳","卯","丑","亥","酉","未"] }
}
```

### 4.4 世爻和应爻的确定方法

世爻和应爻通过 **八宫卦序** 确定：

#### 八宫结构

每宫以一个八纯卦为首卦（本宫卦），然后依次从初爻开始逐爻变化，形成八个卦：

| 序号 | 名称 | 变化规则 | 世爻位置 | 应爻位置 |
|------|------|---------|---------|---------|
| 1 | 本宫卦（八纯卦）| 不变 | 六爻（上爻）| 三爻 |
| 2 | 一世卦 | 初爻变 | 初爻 | 四爻 |
| 3 | 二世卦 | 初、二爻变 | 二爻 | 五爻 |
| 4 | 三世卦 | 初、二、三爻变 | 三爻 | 六爻（上爻）|
| 5 | 四世卦 | 初至四爻变 | 四爻 | 初爻 |
| 6 | 五世卦 | 初至五爻变 | 五爻 | 二爻 |
| 7 | 游魂卦 | 初至五爻变后，四爻变回 | 四爻 | 初爻 |
| 8 | 归魂卦 | 内卦恢复为本宫卦 | 三爻 | 六爻（上爻）|

**应爻规则：** 世爻与应爻之间总是相隔两位（即世爻 + 3 = 应爻位置，mod 6循环）。

#### 以乾宫为例

| 序号 | 卦名 | 卦象 | 世爻 | 应爻 |
|------|------|------|------|------|
| 1 | 乾为天 | 111111 | 六爻 | 三爻 |
| 2 | 天风姤 | 111110 | 初爻 | 四爻 |
| 3 | 天山遁 | 111100 | 二爻 | 五爻 |
| 4 | 天地否 | 111000 | 三爻 | 六爻 |
| 5 | 风地观 | 110000 | 四爻 | 初爻 |
| 6 | 山地剥 | 100000 | 五爻 | 二爻 |
| 7 | 火地晋 | 101000 | 四爻 | 初爻 |
| 8 | 火天大有 | 101111 | 三爻 | 六爻 |

> 注：卦象中1=阳爻，0=阴爻，从左到右为上爻到初爻

### 4.5 六亲的推导

六亲以 **日干**（占卜当日的天干）所属五行为"我"，与每爻地支所属五行比较：

| 关系 | 定义 | 说明 |
|------|------|------|
| 兄弟 | 与我同五行 | 同类 |
| 子孙 | 我生者 | 我所生的 |
| 妻财 | 我克者 | 我能克制的 |
| 官鬼 | 克我者 | 能克制我的 |
| 父母 | 生我者 | 能生我的 |

**五行相生顺序：** 木→火→土→金→水→木

**六亲推导示例：**
- 日干为甲（木）：
  - 兄弟 = 木（寅、卯）
  - 子孙 = 火（巳、午）
  - 妻财 = 土（辰、戌、丑、未）
  - 官鬼 = 金（申、酉）
  - 父母 = 水（亥、子）

**注意：** 实际装卦时，六亲是以 **卦的五行属性**（而非日干）为"我"来推导的。日干用于确定六神。六亲以本宫五行为"我"。

### 4.6 六神（六兽）的配置方法

六神根据 **占卜当日的天干** 确定，从初爻到上爻依次排列：

| 日干 | 初爻起 | 排列顺序 |
|------|--------|---------|
| 甲、乙 | 青龙 | 青龙→朱雀→勾陈→螣蛇→白虎→玄武 |
| 丙、丁 | 朱雀 | 朱雀→勾陈→螣蛇→白虎→玄武→青龙 |
| 戊 | 勾陈 | 勾陈→螣蛇→白虎→玄武→青龙→朱雀 |
| 己 | 螣蛇 | 螣蛇→白虎→玄武→青龙→朱雀→勾陈 |
| 庚、辛 | 白虎 | 白虎→玄武→青龙→朱雀→勾陈→螣蛇 |
| 壬、癸 | 玄武 | 玄武→青龙→朱雀→勾陈→螣蛇→白虎 |

**六神固定循环顺序：** 青龙→朱雀→勾陈→螣蛇→白虎→玄武

**六神五行属性：**

| 六神 | 五行 | 象征 |
|------|------|------|
| 青龙 | 木 | 吉庆、财富 |
| 朱雀 | 火 | 口舌、文书 |
| 勾陈 | 阳土 | 田地、牢狱 |
| 螣蛇 | 阴土 | 怪异、虚惊 |
| 白虎 | 金 | 凶丧、疾病 |
| 玄武 | 水 | 盗贼、暗昧 |

**口诀：** "甲乙起青龙，丙丁起朱雀，戊起勾陈，己起螣蛇，庚辛起白虎，壬癸起玄武"

---

## 5. 变卦规则

### 5.1 本卦 → 之卦（变卦）

变卦的生成规则：
- 本卦中所有 **变爻**（老阴6、老阳9）取反
  - 老阳(9) → 变为阴爻
  - 老阴(6) → 变为阳爻
- 不变爻（少阳7、少阴8）保持不变
  - 少阳(7) → 仍为阳爻
  - 少阴(8) → 仍为阴爻

**编程实现：**
```
function getChangedHexagram(yao[6]):
    changed = []
    for i in 0..5:
        if yao[i] == 9:      // 老阳变阴
            changed[i] = 0   // 阴
        elif yao[i] == 6:    // 老阴变阳
            changed[i] = 1   // 阳
        elif yao[i] == 7:    // 少阳不变
            changed[i] = 1   // 阳
        elif yao[i] == 8:    // 少阴不变
            changed[i] = 0   // 阴
    return changed
```

### 5.2 互卦

互卦是从本卦的中间四爻（第2、3、4、5爻）中取出：

- **下卦（内卦）：** 取本卦的第2、3、4爻
- **上卦（外卦）：** 取本卦的第3、4、5爻

> 注意：第3、4爻在上下卦中共用

**编程实现：**
```
function getInterHexagram(yao[6]):
    // yao[0]=初爻, yao[5]=上爻
    lower = [yao[1], yao[2], yao[3]]  // 2,3,4爻
    upper = [yao[2], yao[3], yao[4]]  // 3,4,5爻
    return upper + lower  // 组合为新的六爻卦
```

**特殊情况：** 乾卦的互卦仍为乾，坤卦的互卦仍为坤。

### 5.3 错卦（旁通卦）

每一爻阴阳取反：
- 阳爻 → 阴爻
- 阴爻 → 阳爻

**编程实现：**
```
function getOppositeHexagram(yao[6]):
    return [1-yao[i] for i in 0..5]  // 每爻取反
```

**示例：** 乾（111111）的错卦是坤（000000）

**特性：** 64卦中有8个卦的错卦是自己（不存在，实际上没有这样的卦，每个卦的错卦都是不同的卦或自身的对立面）。

### 5.4 综卦（覆卦）

将整个卦 **上下颠倒**（180度旋转）：

**编程实现：**
```
function getReversedHexagram(yao[6]):
    return [yao[5], yao[4], yao[3], yao[2], yao[1], yao[0]]  // 翻转
```

**示例：** 屯卦（010001）的综卦是蒙卦（100010）

**自综卦（颠倒后不变的卦）：** 共8个
- 乾（111111）、坤（000000）
- 坎（010010）、离（101101）
- 中孚（110011）、小过（001100）
- 大过（011110）、颐（100001）

### 5.5 变卦断卦规则（传统）

根据变爻的数量决定断法（以铜钱法为例）：

| 变爻数 | 断卦方法 |
|--------|---------|
| 0个变爻 | 以本卦卦辞断 |
| 1个变爻 | 以本卦变爻的爻辞断 |
| 2个变爻 | 以本卦两个变爻的爻辞断（以上爻为主） |
| 3个变爻 | 以本卦卦辞断，参考变卦卦辞 |
| 4个变爻 | 以变卦中两个不变爻的爻辞断 |
| 5个变爻 | 以变卦中不变爻的爻辞断 |
| 6个变爻 | 乾坤两卦用"用九"/"用六"断，其余以变卦卦辞断 |

---

## 6. 各方法的编程实现要点

### 6.1 随机数选择

#### 伪随机数 vs 真随机数

| 方面 | 伪随机数（PRNG） | 真随机数（TRNG） |
|------|----------------|----------------|
| 来源 | 算法生成（如 Mersenne Twister） | 硬件熵源、大气噪声等 |
| 可重现 | 给定种子可重现 | 不可重现 |
| 速度 | 极快 | 较慢 |
| 适用场景 | 模拟、测试、概率验证 | 实际占卜体验 |

**建议：**
- 概率验证和测试：使用伪随机数（可设种子复现）
- 实际占卜功能：使用系统提供的密码学安全随机数生成器（如 `crypto.getRandomValues()`）
- 梅花易数时间起卦：不需要随机数，基于确定性计算

### 6.2 大衍筮法的算法实现要点

```
function dayanOneChange(total):
    // total: 当前可用蓍草数（第一变为49，后续为上一变剩余）

    // 分二：随机分成左右两堆
    left = random(1, total - 1)
    right = total - left

    // 挂一：从右堆取1根
    right = right - 1
    guayi = 1

    // 揲四：左右各除以4取余
    r_left = left mod 4
    if r_left == 0: r_left = 4   // 余数为0时取4
    r_right = right mod 4
    if r_right == 0: r_right = 4 // 余数为0时取4

    // 归奇：合并余数
    guiqi = guayi + r_left + r_right

    // 剩余蓍草
    remaining = total - guiqi
    return remaining

function dayanOneYao():
    // 三变成一爻
    remaining = dayanOneChange(49)   // 第一变
    remaining = dayanOneChange(remaining)  // 第二变
    remaining = dayanOneChange(remaining)  // 第三变

    // remaining 只可能是 24, 28, 32, 36
    return remaining / 4  // 返回 6, 7, 8, 9

function dayanHexagram():
    yao = []
    for i in 0..5:
        yao[i] = dayanOneYao()
    return yao
```

**验证要点：**
- 第一变归奇数必为5或9
- 第二变归奇数必为4或8
- 第三变归奇数必为4或8
- 最终结果必为24/28/32/36之一
- 大量模拟应接近概率分布：6=1/16, 7=5/16, 8=7/16, 9=3/16

### 6.3 铜钱法的简单模拟

```
function coinMethod():
    sum = 0
    for i in 0..2:
        // 0=字面(阴)=2, 1=背面(阳)=3
        face = randomInt(0, 1)
        sum += (face == 0) ? 2 : 3
    return sum  // 6, 7, 8, 或 9

function coinHexagram():
    yao = []
    for i in 0..5:
        yao[i] = coinMethod()
    return yao
```

### 6.4 梅花易数的时间计算

**关键问题：农历转换**

梅花易数时间起卦需要使用 **农历日期**，这在编程中是一个重要难点：

1. **农历转换库：** 不要自己实现农历算法，使用成熟的库
   - JavaScript: `lunar-javascript`, `chinese-lunar`
   - Python: `lunardate`, `zhdate`, `cnlunar`
   - Go: `github.com/nosixtools/solarlunar`

2. **年份地支计算（不需要农历库）：**
   ```
   // 天干地支纪年可用公式计算
   // 地支序号 = (年份 - 4) mod 12
   // 0=子, 1=丑, 2=寅, ..., 11=亥
   // 地支数 = 地支序号 + 1（若为0则取12）

   function getZhiNumber(year):
       idx = (year - 4) mod 12
       return idx == 0 ? 12 : idx  // 注意：这里子=1, 但按地支序计算时0=子
       // 更准确：(year - 4) mod 12 得到 0=子,1=丑,...,11=亥
       // 地支数 = ((year - 4) mod 12) + 1，但子对应1而非0
       // 简化：dizhi_num = ((year - 4) % 12)
       //   0→子→1, 1→丑→2, ... 11→亥→12
       //   return dizhi_num == 0 ? 12 : dizhi_num  // 错误，应该+1
       //   正确：return (year - 4) % 12 + 1  // 但这样子=1没问题
       //   等等：(2024-4)%12 = 2020%12 = 4 → 4+1=5=辰，2024是甲辰年，辰=5 ✓
   ```

   **简化公式：**
   ```
   dizhi_number = ((year - 4) % 12) + 1
   // 若结果为13则取1（实际不会发生，因为 0~11 + 1 = 1~12）
   ```

   **验证：**
   - 2024年：(2024-4)%12 + 1 = 4 + 1 = 5（辰），甲辰年 ✓
   - 2023年：(2023-4)%12 + 1 = 3 + 1 = 4（卯），癸卯年 ✓

3. **时辰计算：**
   ```
   function getShichenNumber(hour):
       // 23:00-0:59 = 子时(1)
       // 1:00-2:59 = 丑时(2)
       // ...以此类推，每2小时一个时辰
       if hour == 23 or hour == 0:
           return 1  // 子时
       return Math.floor((hour + 1) / 2) + 1
   ```

4. **完整梅花易数时间起卦算法：**
   ```
   function meihuaTimeHexagram(lunarYear, lunarMonth, lunarDay, hour):
       yearNum = getZhiNumber(lunarYear)  // 年地支数
       monthNum = lunarMonth              // 农历月数
       dayNum = lunarDay                  // 农历日数
       hourNum = getShichenNumber(hour)   // 时辰数

       sumYMD = yearNum + monthNum + dayNum
       sumAll = sumYMD + hourNum

       upperGua = sumYMD % 8
       if upperGua == 0: upperGua = 8

       lowerGua = sumAll % 8
       if lowerGua == 0: lowerGua = 8

       dongYao = sumAll % 6
       if dongYao == 0: dongYao = 6

       return { upper: upperGua, lower: lowerGua, movingLine: dongYao }
   ```

### 6.5 通用工具函数

```
// 爻值转阴阳
function yaoToYinYang(value):
    if value == 7 or value == 9:
        return 1  // 阳
    else:  // 6 or 8
        return 0  // 阴

// 判断是否为变爻
function isChanging(value):
    return value == 6 or value == 9

// 三爻转八卦序号（二进制）
// 初爻在最低位
function trigramToIndex(y1, y2, y3):
    return y1 * 1 + y2 * 2 + y3 * 4
    // 乾=7(111), 兑=6(110), 离=5(101), 震=4(100)
    // 巽=3(011), 坎=2(010), 艮=1(001), 坤=0(000)
    // 注意：这个二进制编码需要与先天/后天八卦序号建立映射

// 八卦二进制与名称映射
TRIGRAM_NAMES = {
    "111": "乾", "110": "兑", "101": "离", "100": "震",
    "011": "巽", "010": "坎", "001": "艮", "000": "坤"
}
```

### 6.6 概率验证测试

```
function verifyDayanProbability(iterations = 1000000):
    counts = {6: 0, 7: 0, 8: 0, 9: 0}
    for i in 0..iterations:
        result = dayanOneYao()
        counts[result]++

    // 期望概率
    expected = {6: 1/16, 7: 5/16, 8: 7/16, 9: 3/16}

    for key in counts:
        actual = counts[key] / iterations
        print(f"爻值{key}: 实际={actual:.4f}, 期望={expected[key]:.4f}")

function verifyCoinProbability(iterations = 1000000):
    counts = {6: 0, 7: 0, 8: 0, 9: 0}
    for i in 0..iterations:
        result = coinMethod()
        counts[result]++

    // 期望概率
    expected = {6: 1/8, 7: 3/8, 8: 3/8, 9: 1/8}

    for key in counts:
        actual = counts[key] / iterations
        print(f"爻值{key}: 实际={actual:.4f}, 期望={expected[key]:.4f}")
```

---

## 参考资料

- 《周易·系辞传》
- 《梅花易数》（宋）邵雍
- 《火珠林》
- 《卜筮正宗》
- 孙涤《解析大衍筮法及易卦的蓍占概率》，山东大学《文史哲》2018年
